import { useState, useEffect, useCallback } from 'react'
import Head from 'next/head'
import Link from 'next/link'
import { supabase, getEvents, getAllEvents, createEvent, updateEvent, deleteEvent, getEventTables, createEventTable, deleteEventTable, getAllMenuItems, createMenuItem, updateMenuItem, deleteMenuItem, duplicateMenuItem, updateMenuItemOrder, getEventMenu, setEventMenuPrice, getWaiters, createWaiter, deleteWaiter, restoreWaiter, getWaiterStats, getEventWaiters, addWaiterToEvent, removeWaiterFromEvent, getTableAssignments, assignTableToWaiter, getCustomers, getCustomersFiltered, getAnalytics, getEventAnalytics, getWaiterLeaderboard, getEventReservations, createReservation, deleteReservation, getLayoutTemplates, createLayoutTemplate, deleteLayoutTemplate, applyLayoutTemplate, getMenuTemplates, createMenuTemplate, deleteMenuTemplate, applyMenuTemplate, updateCategoryOrder, createCategory, updateCategoryName, deleteCategory, bulkDeleteMenuItems, bulkUpdateMenuItems, setDefaultMenuTemplate, getDefaultMenuTemplate } from '../lib/supabase'

const VENUE_ID = '11111111-1111-1111-1111-111111111111'
const colors = { noir: '#08080a', onyx: '#141416', champagne: '#d4af37', platinum: '#e5e4e2', ivory: '#fffff0', border: 'rgba(255,255,255,0.12)', textMuted: 'rgba(255,255,255,0.55)', success: '#22c55e', error: '#ef4444', warning: '#f59e0b', vip: '#d4af37', normal: '#3b82f6', bar: '#8b5cf6' }
const TABLE_TYPES = { vip: { label: 'VIP', color: colors.vip }, normal: { label: 'Normal', color: colors.normal }, bar: { label: 'Bar', color: colors.bar } }
const PRODUCT_TYPES = ['bottle', 'cocktail', 'shot', 'beer', 'wine', 'soft', 'food', 'other']
const BADGES = ['popular', 'premium', 'new', 'recommended']

export default function ManagerDashboard() {
  const [isDesktop, setIsDesktop] = useState(false)
  const [activeTab, setActiveTab] = useState('overview')
  const [events, setEvents] = useState([])
  const [allEvents, setAllEvents] = useState([])
  const [selectedEvent, setSelectedEvent] = useState(null)
  const [eventTables, setEventTables] = useState([])
  const [reservations, setReservations] = useState([])
  const [layoutTemplates, setLayoutTemplates] = useState([])
  const [menuTemplates, setMenuTemplates] = useState([])
  const [defaultTemplateId, setDefaultTemplateId] = useState(null)
  const [activeZone, setActiveZone] = useState('front')
  const [frontGridRows, setFrontGridRows] = useState(6)
  const [frontGridCols, setFrontGridCols] = useState(8)
  const [backGridRows, setBackGridRows] = useState(6)
  const [backGridCols, setBackGridCols] = useState(8)
  const [menuItems, setMenuItems] = useState([])
  const [categories, setCategories] = useState([])
  const [eventMenu, setEventMenu] = useState([])
  const [waiters, setWaiters] = useState([])
  const [waiterFilter, setWaiterFilter] = useState('active')
  const [selectedWaiter, setSelectedWaiter] = useState(null)
  const [waiterStats, setWaiterStats] = useState({})
  const [eventWaiters, setEventWaiters] = useState([])
  const [tableAssignments, setTableAssignments] = useState([])
  const [customers, setCustomers] = useState([])
  const [customerFilter, setCustomerFilter] = useState({ period: 'all', eventId: null })
  const [analytics, setAnalytics] = useState({})
  const [eventAnalytics, setEventAnalytics] = useState({})
  const [leaderboard, setLeaderboard] = useState([])
  const [loading, setLoading] = useState(true)
  const [analyticsPeriod, setAnalyticsPeriod] = useState('month')
  const [statsEventFilter, setStatsEventFilter] = useState('all')
  const [crmCustomers, setCrmCustomers] = useState([])
  const [selectedCustomer, setSelectedCustomer] = useState(null)
  const [showCustomerModal, setShowCustomerModal] = useState(false)
  const [showEventModal, setShowEventModal] = useState(false)
  const [showWaiterModal, setShowWaiterModal] = useState(false)
  const [showReservationModal, setShowReservationModal] = useState(false)
  const [showProductModal, setShowProductModal] = useState(false)
  const [showLayoutModal, setShowLayoutModal] = useState(false)
  const [showMenuTemplateModal, setShowMenuTemplateModal] = useState(false)
  const [showWaiterStatsModal, setShowWaiterStatsModal] = useState(false)
  const [showBulkPriceModal, setShowBulkPriceModal] = useState(false)
  const [showCategoryOrderModal, setShowCategoryOrderModal] = useState(false)
  const [showCategoryEditModal, setShowCategoryEditModal] = useState(false)
  const [showAssignModal, setShowAssignModal] = useState(false)
  const [editingEvent, setEditingEvent] = useState(null)
  const [editingProduct, setEditingProduct] = useState(null)
  const [editingCategory, setEditingCategory] = useState(null)
  const [selectedTableForRes, setSelectedTableForRes] = useState(null)
  const [selectedTableType, setSelectedTableType] = useState('normal')
  const [selectedTableForAssign, setSelectedTableForAssign] = useState(null)
  const [selectedItems, setSelectedItems] = useState(new Set())
  const [selectMode, setSelectMode] = useState(false)
  const [eventForm, setEventForm] = useState({ name: '', event_date: '', start_time: '22:00', description: '' })
  const [waiterForm, setWaiterForm] = useState({ name: '', phone: '' })
  const [reservationForm, setReservationForm] = useState({ customer_name: '', customer_phone: '', party_size: 2, reservation_time: '22:00', notes: '', is_vip: false })
  const [productForm, setProductForm] = useState({ name: '', description: '', default_price: '', category_id: '', product_type: 'cocktail', badge: '', is_available: true })
  const [layoutName, setLayoutName] = useState('')
  const [menuTemplateName, setMenuTemplateName] = useState('')
  const [categoryName, setCategoryName] = useState('')
  const [selectedTemplate, setSelectedTemplate] = useState(null)
  const [selectedMenuTemplate, setSelectedMenuTemplate] = useState(null)
  const [bulkPriceChange, setBulkPriceChange] = useState({ type: 'percent', value: 0 })
  const [tempCategoryOrder, setTempCategoryOrder] = useState([])

  useEffect(() => { const c = () => setIsDesktop(window.innerWidth >= 900); c(); window.addEventListener('resize', c); return () => window.removeEventListener('resize', c) }, [])
  useEffect(() => { loadData() }, [])
  useEffect(() => { if (selectedEvent) loadEventData(selectedEvent.id) }, [selectedEvent])
  useEffect(() => { loadAnalytics() }, [analyticsPeriod, statsEventFilter])
  useEffect(() => { loadWaiters() }, [waiterFilter])
  useEffect(() => { loadCustomers() }, [customerFilter])

  const loadData = async () => {
    setLoading(true)
    const [evRes, allEvRes, menuRes, catsRes, layRes, menuTRes, defTRes] = await Promise.all([getEvents(VENUE_ID), getAllEvents(VENUE_ID), getAllMenuItems(VENUE_ID), supabase.from('categories').select('*').eq('venue_id', VENUE_ID).eq('is_active', true).order('sort_order'), getLayoutTemplates(VENUE_ID), getMenuTemplates(VENUE_ID), getDefaultMenuTemplate(VENUE_ID)])
    if (evRes.data?.length) { setEvents(evRes.data); setSelectedEvent(evRes.data[0]) }
    if (allEvRes.data) setAllEvents(allEvRes.data)
    if (menuRes.data) { const unique = [], seen = new Set(); for (const item of menuRes.data) { const key = `${item.name}-${item.category_id}`; if (!seen.has(key)) { seen.add(key); unique.push(item) } }; setMenuItems(unique) }
    if (catsRes.data) { const uniqueCats = [], seenCats = new Set(); for (const cat of catsRes.data) { if (!seenCats.has(cat.name)) { seenCats.add(cat.name); uniqueCats.push(cat) } }; setCategories(uniqueCats) }
    if (layRes.data) setLayoutTemplates(layRes.data)
    if (menuTRes?.data) setMenuTemplates(menuTRes.data)
    if (defTRes?.data) setDefaultTemplateId(defTRes.data.id)
    await loadWaiters(); await loadAnalytics(); await loadCustomers(); await loadCRMCustomers()
    setLoading(false)
  }
  const loadWaiters = async () => { const { data } = await getWaiters(VENUE_ID, waiterFilter); if (data) setWaiters(data) }
  const loadCustomers = async () => { const { data } = await getCustomersFiltered({ ...customerFilter, limit: 50 }); if (data) setCustomers(data) }
  const loadEventData = async (eventId) => {
    const [tRes, ewRes, aRes, emRes, resRes, eaRes] = await Promise.all([getEventTables(eventId), getEventWaiters(eventId), getTableAssignments(eventId), getEventMenu(eventId), getEventReservations(eventId), getEventAnalytics(eventId)])
    if (tRes.data) { setEventTables(tRes.data); const fT = tRes.data.filter(t => t.zone !== 'back'), bT = tRes.data.filter(t => t.zone === 'back'); if (fT.length) { setFrontGridRows(Math.max(6, Math.max(...fT.map(t => t.grid_row)) + 2)); setFrontGridCols(Math.max(8, Math.max(...fT.map(t => t.grid_col)) + 2)) }; if (bT.length) { setBackGridRows(Math.max(6, Math.max(...bT.map(t => t.grid_row)) + 2)); setBackGridCols(Math.max(8, Math.max(...bT.map(t => t.grid_col)) + 2)) } }
    if (ewRes.data) setEventWaiters(ewRes.data); if (aRes.data) setTableAssignments(aRes.data); if (emRes.data) setEventMenu(emRes.data); if (resRes.data) setReservations(resRes.data); if (eaRes) setEventAnalytics(eaRes)
    await loadLeaderboard(eventId)
  }
  const loadAnalytics = async () => {
    let query = supabase.from('orders').select('total, created_at, event_id, customer_phone, payment_status').eq('venue_id', VENUE_ID)
    const now = new Date()
    if (analyticsPeriod === 'week') query = query.gte('created_at', new Date(now - 7 * 24 * 60 * 60 * 1000).toISOString())
    else if (analyticsPeriod === 'month') query = query.gte('created_at', new Date(now - 30 * 24 * 60 * 60 * 1000).toISOString())
    else if (analyticsPeriod === 'year') query = query.gte('created_at', new Date(now - 365 * 24 * 60 * 60 * 1000).toISOString())
    if (statsEventFilter !== 'all') query = query.eq('event_id', statsEventFilter)
    const { data: orders } = await query
    const paidOrders = orders?.filter(o => o.payment_status === 'paid') || []
    const totalSales = paidOrders.reduce((sum, o) => sum + (o.total || 0), 0)
    const totalOrders = orders?.length || 0
    const uniqueCustomers = new Set(orders?.filter(o => o.customer_phone).map(o => o.customer_phone)).size
    setAnalytics({ totalSales, totalOrders, totalCustomers: uniqueCustomers })
  }
  const loadLeaderboard = async (eventId) => {
    const data = await getWaiterLeaderboard(eventId)
    if (!data || data.length === 0) { setLeaderboard([]); return }
    setLeaderboard(data.map(w => ({ id: w.id, name: w.name, totalSales: w.event_sales || 0, orderCount: w.event_orders || 0 })))
  }
  const loadCRMCustomers = async () => {
    const { data: allRes } = await supabase.from('reservations').select('*, event_tables(*), events(*)').eq('venue_id', VENUE_ID).order('created_at', { ascending: false })
    if (!allRes) { setCrmCustomers([]); return }
    const customerMap = new Map()
    for (const res of allRes) { const key = res.customer_phone || res.customer_name; if (!key) continue; if (!customerMap.has(key)) { customerMap.set(key, { name: res.customer_name, phone: res.customer_phone, email: res.customer_email, isVip: res.is_vip, reservations: [], totalSpend: 0, eventCount: 0 }) }; const customer = customerMap.get(key); if (res.is_vip) customer.isVip = true; const { data: tableOrders } = await supabase.from('orders').select('total').eq('event_table_id', res.event_table_id).eq('event_id', res.event_id).eq('payment_status', 'paid'); const tableSpend = tableOrders?.reduce((sum, o) => sum + (o.total || 0), 0) || 0; customer.totalSpend += tableSpend; customer.eventCount++; customer.reservations.push({ ...res, tableSpend }) }
    setCrmCustomers(Array.from(customerMap.values()).sort((a, b) => b.totalSpend - a.totalSpend))
  }
  const loadWaiterStats = async (w) => { 
    setSelectedWaiter(w)
    const { data: globalOrders } = await supabase.from('orders').select('total').eq('waiter_id', w.id).eq('payment_status', 'paid')
    const globalSales = globalOrders?.reduce((sum, o) => sum + (o.total || 0), 0) || 0
    let eventSales = 0, eventOrders = 0
    if (selectedEvent) { const { data: evOrders } = await supabase.from('orders').select('total').eq('waiter_id', w.id).eq('event_id', selectedEvent.id).eq('payment_status', 'paid'); eventSales = evOrders?.reduce((sum, o) => sum + (o.total || 0), 0) || 0; eventOrders = evOrders?.length || 0 }
    setWaiterStats({ global: { totalSales: globalSales, totalOrders: globalOrders?.length || 0 }, event: { totalSales: eventSales, totalOrders: eventOrders } })
    setShowWaiterStatsModal(true)
  }

  const handleCreateEvent = async () => { if (!eventForm.name || !eventForm.event_date) return; const { data } = await createEvent({ ...eventForm, venue_id: VENUE_ID }); if (data) { if (selectedTemplate) await applyLayoutTemplate(selectedTemplate, data.id); const templateToApply = selectedMenuTemplate || defaultTemplateId; if (templateToApply) await applyMenuTemplate(templateToApply, data.id); setSelectedEvent(data) }; closeEventModal(); loadData() }
  const handleUpdateEvent = async () => { if (!editingEvent || !eventForm.name) return; await updateEvent(editingEvent.id, eventForm); closeEventModal(); loadData() }
  const closeEventModal = () => { setShowEventModal(false); setEditingEvent(null); setSelectedTemplate(null); setSelectedMenuTemplate(null); setEventForm({ name: '', event_date: '', start_time: '22:00', description: '' }) }
  const openEditEvent = (ev) => { setEditingEvent(ev); setEventForm({ name: ev.name, event_date: ev.event_date, start_time: ev.start_time, description: ev.description || '' }); setShowEventModal(true) }
  const handleDeleteEvent = async (e, id) => { e.stopPropagation(); if (!confirm('È˜tergi?')) return; await deleteEvent(id); setSelectedEvent(null); loadData() }
  const handleSaveLayout = async () => { if (!layoutName || !eventTables.length) return; await createLayoutTemplate(VENUE_ID, layoutName, eventTables); setLayoutName(''); setShowLayoutModal(false); const { data } = await getLayoutTemplates(VENUE_ID); if (data) setLayoutTemplates(data) }
  const handleDeleteTemplate = async (id) => { if (!confirm('È˜tergi?')) return; await deleteLayoutTemplate(id); const { data } = await getLayoutTemplates(VENUE_ID); if (data) setLayoutTemplates(data) }
  const handleCellClick = async (row, col) => { const zT = eventTables.filter(t => activeZone === 'front' ? t.zone !== 'back' : t.zone === 'back'); if (zT.some(t => t.grid_row === row && t.grid_col === col)) return; const cnt = zT.filter(t => t.table_type === selectedTableType).length + 1; const pre = selectedTableType === 'vip' ? 'VIP' : selectedTableType === 'bar' ? 'B' : 'M'; const suf = activeZone === 'back' ? '-S' : ''; await createEventTable({ event_id: selectedEvent.id, table_number: `${pre}${cnt}${suf}`, table_type: selectedTableType, capacity: selectedTableType === 'vip' ? 8 : selectedTableType === 'bar' ? 2 : 4, min_spend: selectedTableType === 'vip' ? 1500 : selectedTableType === 'bar' ? 0 : 500, grid_row: row, grid_col: col, zone: activeZone }); loadEventData(selectedEvent.id) }
  const handleTableClick = async (e, t) => { e.stopPropagation(); if (confirm(`È˜tergi ${t.table_number}?`)) { await deleteEventTable(t.id); loadEventData(selectedEvent.id) } }
  const addRow = () => activeZone === 'front' ? setFrontGridRows(p => p + 1) : setBackGridRows(p => p + 1)
  const addCol = () => activeZone === 'front' ? setFrontGridCols(p => p + 1) : setBackGridCols(p => p + 1)
  const loadMenuOnly = async () => { const [menuRes, catsRes] = await Promise.all([getAllMenuItems(VENUE_ID), supabase.from('categories').select('*').eq('venue_id', VENUE_ID).eq('is_active', true).order('sort_order')]); if (menuRes.data) { const unique = [], seen = new Set(); for (const item of menuRes.data) { const key = `${item.name}-${item.category_id}`; if (!seen.has(key)) { seen.add(key); unique.push(item) } }; setMenuItems(unique) }; if (catsRes.data) { const uniqueCats = [], seenCats = new Set(); for (const cat of catsRes.data) { if (!seenCats.has(cat.name)) { seenCats.add(cat.name); uniqueCats.push(cat) } }; setCategories(uniqueCats) } }
  const handleCreateProduct = async () => { if (!productForm.name || !productForm.default_price || !productForm.category_id) return; await createMenuItem({ ...productForm, venue_id: VENUE_ID, default_price: parseFloat(productForm.default_price) }); closeProductModal(); loadMenuOnly() }
  const handleUpdateProduct = async () => { if (!editingProduct) return; await updateMenuItem(editingProduct.id, { ...productForm, default_price: parseFloat(productForm.default_price) }); closeProductModal(); loadMenuOnly() }
  const closeProductModal = () => { setShowProductModal(false); setEditingProduct(null); setProductForm({ name: '', description: '', default_price: '', category_id: '', product_type: 'cocktail', badge: '', is_available: true }) }
  const openEditProduct = (item) => { setEditingProduct(item); setProductForm({ name: item.name, description: item.description || '', default_price: item.default_price, category_id: item.category_id, product_type: item.product_type || 'cocktail', badge: item.badge || '', is_available: item.is_available }); setShowProductModal(true) }
  const handleDuplicateProduct = async (id) => { await duplicateMenuItem(id); loadData() }
  const handleToggleStock = async (item) => { await updateMenuItem(item.id, { is_available: !item.is_available }); loadMenuOnly() }
  const handleDeleteProduct = async (id) => { if (!confirm('È˜tergi?')) return; await deleteMenuItem(id); loadMenuOnly() }
  const handleMoveProduct = async (item, direction) => { const catItems = menuItems.filter(m => m.category_id === item.category_id).sort((a, b) => (a.sort_order || 0) - (b.sort_order || 0)); const idx = catItems.findIndex(m => m.id === item.id); const newIdx = direction === 'up' ? idx - 1 : idx + 1; if (newIdx < 0 || newIdx >= catItems.length) return; const reordered = [...catItems]; reordered.splice(idx, 1); reordered.splice(newIdx, 0, item); await updateMenuItemOrder(reordered); loadMenuOnly() }
  const handleBulkPrice = async () => { const itemsToUpdate = selectMode && selectedItems.size > 0 ? menuItems.filter(m => selectedItems.has(m.id)) : menuItems; for (const item of itemsToUpdate) { let nP = bulkPriceChange.type === 'percent' ? item.default_price * (1 + bulkPriceChange.value / 100) : item.default_price + bulkPriceChange.value; await updateMenuItem(item.id, { default_price: Math.round(nP) }) }; setShowBulkPriceModal(false); setSelectedItems(new Set()); loadMenuOnly() }
  const handleBulkDelete = async () => { if (selectedItems.size === 0) return; if (!confirm(`È˜tergi ${selectedItems.size} produse?`)) return; await bulkDeleteMenuItems(Array.from(selectedItems)); setSelectedItems(new Set()); setSelectMode(false); loadMenuOnly() }
  const handleBulkToggleStock = async (available) => { if (selectedItems.size === 0) return; await bulkUpdateMenuItems(Array.from(selectedItems), { is_available: available }); setSelectedItems(new Set()); loadMenuOnly() }
  const toggleItemSelection = (id) => { const newSet = new Set(selectedItems); if (newSet.has(id)) newSet.delete(id); else newSet.add(id); setSelectedItems(newSet) }
  const selectAllInCategory = (catId) => { const catItems = menuItems.filter(m => m.category_id === catId); const allSelected = catItems.every(m => selectedItems.has(m.id)); const newSet = new Set(selectedItems); if (allSelected) { catItems.forEach(m => newSet.delete(m.id)) } else { catItems.forEach(m => newSet.add(m.id)) }; setSelectedItems(newSet) }
  const handleCreateCategory = async () => { const n = prompt('Nume categorie:'); if (!n) return; await createCategory(VENUE_ID, n); loadMenuOnly() }
  const handleEditCategory = (cat) => { setEditingCategory(cat); setCategoryName(cat.name); setShowCategoryEditModal(true) }
  const handleUpdateCategory = async () => { if (!editingCategory || !categoryName) return; await updateCategoryName(editingCategory.id, categoryName); setShowCategoryEditModal(false); setEditingCategory(null); setCategoryName(''); loadMenuOnly() }
  const handleDeleteCategory = async (id) => { if (menuItems.filter(m => m.category_id === id).length) { alert('Categorie cu produse!'); return }; if (!confirm('È˜tergi?')) return; await deleteCategory(id); loadMenuOnly() }
  const openCategoryOrderModal = () => { setTempCategoryOrder([...categories]); setShowCategoryOrderModal(true) }
  const moveCategoryInOrder = (idx, direction) => { const newIdx = direction === 'up' ? idx - 1 : idx + 1; if (newIdx < 0 || newIdx >= tempCategoryOrder.length) return; const newOrder = [...tempCategoryOrder]; const [moved] = newOrder.splice(idx, 1); newOrder.splice(newIdx, 0, moved); setTempCategoryOrder(newOrder) }
  const saveCategoryOrder = async () => { await updateCategoryOrder(tempCategoryOrder); setShowCategoryOrderModal(false); loadMenuOnly() }
  const handleSaveMenuTemplate = async () => { if (!menuTemplateName) return; await createMenuTemplate(VENUE_ID, menuTemplateName, menuItems); setMenuTemplateName(''); setShowMenuTemplateModal(false); const { data } = await getMenuTemplates(VENUE_ID); if (data) setMenuTemplates(data) }
  const handleDeleteMenuTemplate = async (id) => { if (!confirm('È˜tergi?')) return; await deleteMenuTemplate(id); if (defaultTemplateId === id) setDefaultTemplateId(null); const { data } = await getMenuTemplates(VENUE_ID); if (data) setMenuTemplates(data) }
  const handleSetDefaultTemplate = async (id) => { const newDefault = defaultTemplateId === id ? null : id; await setDefaultMenuTemplate(VENUE_ID, newDefault); setDefaultTemplateId(newDefault) }
  const handleCreateWaiter = async () => { if (!waiterForm.name || !waiterForm.phone) return; await createWaiter({ ...waiterForm, venue_id: VENUE_ID }); setShowWaiterModal(false); setWaiterForm({ name: '', phone: '' }); loadWaiters() }
  const handleDeleteWaiter = async (e, id) => { e.stopPropagation(); if (!confirm('È˜tergi?')) return; await deleteWaiter(id); loadWaiters() }
  const handleRestoreWaiter = async (id) => { await restoreWaiter(id); loadWaiters() }
  const handleToggleWaiterEvent = async (wid) => { if (!selectedEvent) return; const isA = eventWaiters.some(ew => ew.waiter_id === wid); isA ? await removeWaiterFromEvent(selectedEvent.id, wid) : await addWaiterToEvent(selectedEvent.id, wid); loadEventData(selectedEvent.id) }
  const handleTableClickForAssign = (t) => { setSelectedTableForAssign(t); setShowAssignModal(true) }
  const handleAssignWaiterToTable = async (waiterId) => { if (!selectedTableForAssign || !selectedEvent) return; await assignTableToWaiter(selectedTableForAssign.id, waiterId, selectedEvent.id); setShowAssignModal(false); setSelectedTableForAssign(null); loadEventData(selectedEvent.id) }
  const handleUnassignTable = async () => { if (!selectedTableForAssign || !selectedEvent) return; await assignTableToWaiter(selectedTableForAssign.id, null, selectedEvent.id); setShowAssignModal(false); setSelectedTableForAssign(null); loadEventData(selectedEvent.id) }
  const [editingReservation, setEditingReservation] = useState(null)
  const handleTableClickForRes = (t) => { const hR = reservations.find(r => r.event_table_id === t.id); if (hR) { setEditingReservation(hR); setSelectedTableForRes(t); setReservationForm({ customer_name: hR.customer_name || '', customer_phone: hR.customer_phone || '', party_size: hR.party_size || 2, reservation_time: hR.reservation_time || '22:00', notes: hR.notes || '', is_vip: hR.is_vip || false }); setShowReservationModal(true) } else { setEditingReservation(null); setSelectedTableForRes(t); setReservationForm({ customer_name: '', customer_phone: '', party_size: 2, reservation_time: '22:00', notes: '', is_vip: false }); setShowReservationModal(true) } }
  const handleCreateRes = async () => { if (!reservationForm.customer_name || !selectedTableForRes) return; await createReservation({ venue_id: VENUE_ID, event_id: selectedEvent.id, event_table_id: selectedTableForRes.id, ...reservationForm }); setShowReservationModal(false); setSelectedTableForRes(null); setEditingReservation(null); loadEventData(selectedEvent.id) }
  const handleUpdateRes = async () => { if (!editingReservation || !reservationForm.customer_name) return; await supabase.from('reservations').update(reservationForm).eq('id', editingReservation.id); setShowReservationModal(false); setSelectedTableForRes(null); setEditingReservation(null); loadEventData(selectedEvent.id) }
  const handleDeleteRes = async (id) => { await deleteReservation(id); loadEventData(selectedEvent.id) }
  const handleDeleteCustomer = async (phone) => { if (!confirm('È˜tergi clientul?')) return; await supabase.from('orders').update({ customer_phone: null, customer_name: null }).eq('customer_phone', phone); loadCustomers() }
  const getAssignedWaiter = (tid) => tableAssignments.find(a => a.event_table_id === tid)?.waiters
  const getTableRes = (tid) => reservations.find(r => r.event_table_id === tid)

  const px = isDesktop ? 24 : 16
  const s = {
    container: { minHeight: '100vh', backgroundColor: colors.noir, color: colors.ivory, fontFamily: "-apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif" },
    header: { backgroundColor: colors.onyx, borderBottom: `1px solid ${colors.border}`, padding: `14px ${px}px`, display: 'flex', alignItems: 'center', justifyContent: 'space-between', position: 'sticky', top: 0, zIndex: 40 },
    logo: { fontSize: isDesktop ? 22 : 18, fontWeight: 300, letterSpacing: 6, color: colors.champagne },
    tabs: { display: 'flex', padding: `0 ${px}px`, borderBottom: `1px solid ${colors.border}`, overflowX: 'auto' },
    tab: { padding: '14px', border: 'none', background: 'none', fontSize: 12, fontWeight: 500, cursor: 'pointer', borderBottom: '2px solid transparent', whiteSpace: 'nowrap' },
    content: { padding: px, maxWidth: 1000, margin: '0 auto' },
    title: { fontSize: 12, fontWeight: 600, letterSpacing: 2, color: colors.textMuted, marginBottom: 16, textTransform: 'uppercase' },
    btn: { padding: '10px 18px', border: 'none', fontSize: 12, fontWeight: 600, cursor: 'pointer', borderRadius: 6 },
    btnSm: { padding: '8px 14px', border: 'none', fontSize: 11, fontWeight: 600, cursor: 'pointer', borderRadius: 4 },
    card: { backgroundColor: colors.onyx, border: `1px solid ${colors.border}`, padding: 16, marginBottom: 12, borderRadius: 8 },
    input: { width: '100%', padding: 14, border: `1px solid ${colors.border}`, backgroundColor: 'transparent', color: colors.ivory, fontSize: 15, marginBottom: 14, borderRadius: 6, outline: 'none', boxSizing: 'border-box' },
    select: { width: '100%', padding: 14, border: `1px solid ${colors.border}`, backgroundColor: colors.onyx, color: colors.ivory, fontSize: 15, marginBottom: 14, borderRadius: 6, boxSizing: 'border-box' },
    label: { display: 'block', fontSize: 11, color: colors.textMuted, letterSpacing: 2, marginBottom: 6, fontWeight: 600 },
    modal: { position: 'fixed', inset: 0, backgroundColor: 'rgba(0,0,0,0.85)', zIndex: 100, display: 'flex', alignItems: 'center', justifyContent: 'center', padding: 16 },
    modalBox: { backgroundColor: colors.onyx, width: '100%', maxWidth: 420, borderRadius: 12, border: `1px solid ${colors.border}`, maxHeight: '90vh', overflowY: 'auto' },
    modalHead: { padding: 18, borderBottom: `1px solid ${colors.border}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center' },
    modalBody: { padding: 18 },
    modalFoot: { padding: 18, borderTop: `1px solid ${colors.border}`, display: 'flex', gap: 12, justifyContent: 'flex-end' },
    statsGrid: { display: 'grid', gridTemplateColumns: isDesktop ? 'repeat(4, 1fr)' : 'repeat(2, 1fr)', gap: 12, marginBottom: 24 },
    stat: { backgroundColor: colors.onyx, border: `1px solid ${colors.border}`, padding: 18, borderRadius: 8, textAlign: 'center' },
    statVal: { fontSize: isDesktop ? 28 : 22, fontWeight: 300, color: colors.champagne },
    statLbl: { fontSize: 10, letterSpacing: 2, color: colors.textMuted, marginTop: 6, fontWeight: 600 },
    zoneTabs: { display: 'flex', marginBottom: 12, border: `1px solid ${colors.border}`, borderRadius: 8, overflow: 'hidden' },
    zoneTab: { flex: 1, padding: '10px 16px', border: 'none', fontSize: 11, fontWeight: 600, cursor: 'pointer' },
    filterRow: { display: 'flex', gap: 8, marginBottom: 16, flexWrap: 'wrap' },
    filterBtn: { padding: '8px 14px', border: `1px solid ${colors.border}`, backgroundColor: 'transparent', color: colors.textMuted, fontSize: 11, cursor: 'pointer', borderRadius: 4 },
    badge: { fontSize: 9, padding: '2px 6px', borderRadius: 4, marginLeft: 6, textTransform: 'uppercase', fontWeight: 700 },
    checkbox: { width: 20, height: 20, border: `2px solid ${colors.border}`, borderRadius: 4, display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer', flexShrink: 0 }
  }
  const TABS = [{ id: 'overview', icon: 'ğŸ“Š', label: 'Stats' }, { id: 'events', icon: 'ğŸ“…', label: 'Events' }, { id: 'layout', icon: 'ğŸ—ºï¸', label: 'Layout' }, { id: 'reservations', icon: 'ğŸ“‹', label: 'RezervÄƒri' }, { id: 'menu', icon: 'ğŸ¸', label: 'Meniu' }, { id: 'qr', icon: 'ğŸ”—', label: 'QR' }, { id: 'waiters', icon: 'ğŸ‘¤', label: 'Staff' }, { id: 'customers', icon: 'ğŸ‘‘', label: 'CRM' }]

  if (loading) return <div style={{...s.container, display: 'flex', alignItems: 'center', justifyContent: 'center'}}><div style={{textAlign: 'center'}}><div style={{fontSize: 40, fontWeight: 300, letterSpacing: 12, color: colors.champagne}}>S I P</div><div style={{fontSize: 12, color: colors.textMuted, marginTop: 16}}>Loading...</div></div></div>

  const curZoneTables = eventTables.filter(t => activeZone === 'front' ? t.zone !== 'back' : t.zone === 'back')
  const curRows = activeZone === 'front' ? frontGridRows : backGridRows
  const curCols = activeZone === 'front' ? frontGridCols : backGridCols
  const activeWaitersOnEvent = eventWaiters.map(ew => waiters.find(w => w.id === ew.waiter_id)).filter(Boolean)
  const waiterColors = ['#22c55e', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316']
  const waiterColorMap = {}
  activeWaitersOnEvent.forEach((w, i) => { waiterColorMap[w.id] = waiterColors[i % waiterColors.length] })

  const renderGrid = (forRes = false) => {
    const cellSize = isDesktop ? 48 : 36, gap = 4
    return (
      <div style={{ overflowX: 'auto' }}>
        <div style={s.zoneTabs}><button onClick={() => setActiveZone('front')} style={{...s.zoneTab, backgroundColor: activeZone === 'front' ? colors.champagne : 'transparent', color: activeZone === 'front' ? colors.noir : colors.textMuted}}>ğŸ­ FaÈ›Äƒ</button><button onClick={() => setActiveZone('back')} style={{...s.zoneTab, backgroundColor: activeZone === 'back' ? colors.champagne : 'transparent', color: activeZone === 'back' ? colors.noir : colors.textMuted}}>ğŸª Spate</button></div>
        {!forRes && <div style={{ display: 'flex', gap: 8, marginBottom: 12, flexWrap: 'wrap', alignItems: 'center' }}><span style={{ fontSize: 11, color: colors.textMuted }}>AdaugÄƒ:</span>{Object.entries(TABLE_TYPES).map(([type, cfg]) => (<button key={type} onClick={() => setSelectedTableType(type)} style={{ padding: '6px 12px', border: `2px solid ${selectedTableType === type ? cfg.color : colors.border}`, backgroundColor: selectedTableType === type ? `${cfg.color}30` : 'transparent', color: cfg.color, borderRadius: 6, cursor: 'pointer', fontSize: 10, fontWeight: 600 }}>{cfg.label}</button>))}<div style={{ flex: 1 }} /><button onClick={() => setShowLayoutModal(true)} style={{...s.btnSm, backgroundColor: colors.champagne, color: colors.noir}}>ğŸ’¾ SalveazÄƒ</button></div>}
        <div style={{ display: 'grid', gridTemplateColumns: `repeat(${curCols}, ${cellSize}px)`, gap, padding: 10, backgroundColor: colors.noir, border: `1px solid ${colors.border}`, borderRadius: 8, width: 'fit-content' }}>{Array.from({ length: curRows }).map((_, row) => Array.from({ length: curCols }).map((_, col) => { const t = curZoneTables.find(t => t.grid_row === row && t.grid_col === col); if (forRes && !t) return <div key={`${row}-${col}`} style={{ width: cellSize, height: cellSize }} />; const cfg = t ? TABLE_TYPES[t.table_type] : null; const hasRes = t && getTableRes(t.id); return (<div key={`${row}-${col}`} onClick={() => forRes ? (t && handleTableClickForRes(t)) : (t ? null : handleCellClick(row, col))} style={{ width: cellSize, height: cellSize, backgroundColor: t ? (hasRes ? `${colors.error}40` : `${cfg.color}25`) : 'rgba(255,255,255,0.03)', border: `2px solid ${t ? (hasRes ? colors.error : cfg.color) : 'transparent'}`, borderRadius: 6, display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', cursor: forRes ? (t ? 'pointer' : 'default') : 'pointer', position: 'relative' }}>{t && <><span style={{ fontSize: 9, fontWeight: 700, color: hasRes ? colors.error : cfg.color }}>{t.table_number}</span>{hasRes && <span style={{ fontSize: 8, color: colors.error }}>ğŸ“‹</span>}{!forRes && <button onClick={(e) => handleTableClick(e, t)} style={{ position: 'absolute', top: -6, right: -6, width: 16, height: 16, borderRadius: '50%', border: 'none', backgroundColor: colors.error, color: '#fff', fontSize: 10, cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>Ã—</button>}</>}</div>) }))}</div>
        {!forRes && <div style={{ marginTop: 12, display: 'flex', gap: 8 }}><button onClick={addRow} style={{...s.btnSm, backgroundColor: 'transparent', border: `1px solid ${colors.border}`, color: colors.textMuted}}>+ RÃ¢nd</button><button onClick={addCol} style={{...s.btnSm, backgroundColor: 'transparent', border: `1px solid ${colors.border}`, color: colors.textMuted}}>+ ColoanÄƒ</button></div>}
      </div>
    )
  }

  const renderStaffGrid = () => {
    const cellSize = isDesktop ? 56 : 44, gap = 6
    return (
      <div style={{ overflowX: 'auto' }}>
        <div style={s.zoneTabs}><button onClick={() => setActiveZone('front')} style={{...s.zoneTab, backgroundColor: activeZone === 'front' ? colors.champagne : 'transparent', color: activeZone === 'front' ? colors.noir : colors.textMuted}}>ğŸ­ FaÈ›Äƒ</button><button onClick={() => setActiveZone('back')} style={{...s.zoneTab, backgroundColor: activeZone === 'back' ? colors.champagne : 'transparent', color: activeZone === 'back' ? colors.noir : colors.textMuted}}>ğŸª Spate</button></div>
        {activeWaitersOnEvent.length > 0 && <div style={{ display: 'flex', gap: 12, marginBottom: 16, flexWrap: 'wrap' }}>{activeWaitersOnEvent.map(w => (<div key={w.id} style={{ display: 'flex', alignItems: 'center', gap: 6 }}><div style={{ width: 12, height: 12, borderRadius: '50%', backgroundColor: waiterColorMap[w.id] }} /><span style={{ fontSize: 11, color: colors.ivory }}>{w.name}</span></div>))}<div style={{ display: 'flex', alignItems: 'center', gap: 6 }}><div style={{ width: 12, height: 12, borderRadius: '50%', backgroundColor: colors.border }} /><span style={{ fontSize: 11, color: colors.textMuted }}>Neatribuit</span></div></div>}
        <div style={{ display: 'grid', gridTemplateColumns: `repeat(${curCols}, ${cellSize}px)`, gap, padding: 10, backgroundColor: colors.noir, border: `1px solid ${colors.border}`, borderRadius: 8, width: 'fit-content' }}>{Array.from({ length: curRows }).map((_, row) => Array.from({ length: curCols }).map((_, col) => { const t = curZoneTables.find(t => t.grid_row === row && t.grid_col === col); if (!t) return <div key={`${row}-${col}`} style={{ width: cellSize, height: cellSize }} />; const cfg = TABLE_TYPES[t.table_type]; const assignment = tableAssignments.find(a => a.event_table_id === t.id); const assignedWaiter = assignment?.waiters; const waiterColor = assignedWaiter ? waiterColorMap[assignedWaiter.id] : null; return (<div key={`${row}-${col}`} onClick={() => handleTableClickForAssign(t)} style={{ width: cellSize, height: cellSize, backgroundColor: waiterColor ? `${waiterColor}30` : `${cfg.color}15`, border: `2px solid ${waiterColor || cfg.color}`, borderRadius: 8, display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', cursor: 'pointer', transition: 'all 0.2s' }}><span style={{ fontSize: 10, fontWeight: 700, color: waiterColor || cfg.color }}>{t.table_number}</span>{assignedWaiter ? <span style={{ fontSize: 8, color: waiterColor, marginTop: 2, maxWidth: cellSize - 8, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>{assignedWaiter.name.split(' ')[0]}</span> : <span style={{ fontSize: 8, color: colors.textMuted, marginTop: 2 }}>â€”</span>}</div>) }))}</div>
        <div style={{ marginTop: 12, fontSize: 11, color: colors.textMuted }}>ğŸ’¡ Click pe o masÄƒ pentru a atribui un ospÄƒtar</div>
      </div>
    )
  }

  return (
    <div style={s.container}>
      <Head><title>S I P - Manager</title></Head>
      <header style={s.header}><div style={s.logo}>S I P</div><Link href="/staff" style={{ fontSize: 12, color: colors.textMuted, textDecoration: 'none' }}>Staff â†’</Link></header>
      <div style={s.tabs}>{TABS.map(tab => (<button key={tab.id} onClick={() => setActiveTab(tab.id)} style={{...s.tab, color: activeTab === tab.id ? colors.champagne : colors.textMuted, borderColor: activeTab === tab.id ? colors.champagne : 'transparent' }}>{tab.icon} {tab.label}</button>))}</div>
      <div style={s.content}>
        {activeTab === 'overview' && (<><div style={{ marginBottom: 24 }}><div style={s.filterRow}>{['week', 'month', 'year', 'all'].map(p => (<button key={p} onClick={() => setAnalyticsPeriod(p)} style={{...s.filterBtn, backgroundColor: analyticsPeriod === p ? colors.champagne : 'transparent', color: analyticsPeriod === p ? colors.noir : colors.textMuted}}>{p === 'week' ? '7 zile' : p === 'month' ? '30 zile' : p === 'year' ? '1 an' : 'Total'}</button>))}<select value={statsEventFilter} onChange={e => setStatsEventFilter(e.target.value)} style={{...s.filterBtn, padding: '8px 12px', backgroundColor: statsEventFilter !== 'all' ? colors.champagne : 'transparent', color: statsEventFilter !== 'all' ? colors.noir : colors.textMuted, border: `1px solid ${colors.border}`, cursor: 'pointer'}}><option value="all">Toate evenimentele</option>{allEvents.map(ev => <option key={ev.id} value={ev.id}>{ev.name}</option>)}</select></div><div style={s.statsGrid}><div style={s.stat}><div style={s.statVal}>{(analytics.totalSales || 0).toLocaleString()}</div><div style={s.statLbl}>LEI TOTAL</div></div><div style={s.stat}><div style={s.statVal}>{analytics.totalOrders || 0}</div><div style={s.statLbl}>COMENZI</div></div><div style={s.stat}><div style={s.statVal}>{analytics.totalOrders > 0 ? Math.round((analytics.totalSales || 0) / analytics.totalOrders) : 0}</div><div style={s.statLbl}>MEDIE/COMANDÄ‚</div></div><div style={s.stat}><div style={s.statVal}>{analytics.totalCustomers || 0}</div><div style={s.statLbl}>CLIENÈšI</div></div></div></div>{selectedEvent && (<div><div style={s.title}>{selectedEvent.name}</div><div style={s.statsGrid}><div style={s.stat}><div style={s.statVal}>{(eventAnalytics.totalSales || 0).toLocaleString()}</div><div style={s.statLbl}>LEI</div></div><div style={s.stat}><div style={s.statVal}>{eventAnalytics.totalOrders || 0}</div><div style={s.statLbl}>COMENZI</div></div><div style={s.stat}><div style={s.statVal}>{eventTables.length}</div><div style={s.statLbl}>MESE</div></div><div style={s.stat}><div style={s.statVal}>{reservations.length}</div><div style={s.statLbl}>REZERVÄ‚RI</div></div></div><div style={{ marginTop: 24 }}><div style={s.title}>TOP STAFF</div>{leaderboard.length === 0 ? (<div style={{ textAlign: 'center', padding: 32, color: colors.textMuted }}>Nicio vÃ¢nzare Ã®ncÄƒ</div>) : leaderboard.map((w, idx) => (<div key={w.id} style={{...s.card, display: 'flex', alignItems: 'center', gap: 16, cursor: 'pointer'}} onClick={() => loadWaiterStats(w)}><div style={{ width: 32, height: 32, borderRadius: '50%', backgroundColor: idx === 0 ? colors.champagne : idx === 1 ? colors.platinum : idx === 2 ? '#cd7f32' : colors.border, color: idx < 3 ? colors.noir : colors.textMuted, display: 'flex', alignItems: 'center', justifyContent: 'center', fontWeight: 700, fontSize: 14 }}>{idx + 1}</div><div style={{ flex: 1 }}><div style={{ fontWeight: 500 }}>{w.name}</div><div style={{ fontSize: 11, color: colors.textMuted }}>{w.orderCount} comenzi</div></div><div style={{ textAlign: 'right' }}><div style={{ fontSize: 16, fontWeight: 600, color: colors.champagne }}>{(w.totalSales || 0).toLocaleString()}</div><div style={{ fontSize: 10, color: colors.textMuted }}>LEI</div></div></div>))}</div></div>)}</>)}
        {activeTab === 'events' && (<><div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 }}><div style={s.title}>Evenimente</div><button onClick={() => setShowEventModal(true)} style={{...s.btn, backgroundColor: colors.champagne, color: colors.noir}}>+ Event</button></div>{events.map(ev => (<div key={ev.id} onClick={() => setSelectedEvent(ev)} style={{...s.card, border: `1px solid ${selectedEvent?.id === ev.id ? colors.champagne : colors.border}`, cursor: 'pointer'}}><div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}><div><div style={{ fontWeight: 500 }}>{ev.name}</div><div style={{ fontSize: 12, color: colors.textMuted }}>{ev.event_date} â€¢ {ev.start_time}</div></div><div style={{ display: 'flex', gap: 8 }}><button onClick={(e) => { e.stopPropagation(); openEditEvent(ev) }} style={{...s.btnSm, backgroundColor: 'transparent', color: colors.champagne, border: `1px solid ${colors.champagne}`}}>âœï¸</button><button onClick={(e) => handleDeleteEvent(e, ev.id)} style={{...s.btnSm, backgroundColor: 'transparent', color: colors.error, border: `1px solid ${colors.error}`}}>âœ•</button></div></div></div>))}</>)}
        {activeTab === 'layout' && selectedEvent && (<><div style={s.title}>Layout: {selectedEvent.name}</div>{renderGrid(false)}{layoutTemplates.length > 0 && (<div style={{ marginTop: 24 }}><div style={s.title}>Template-uri salvate</div>{layoutTemplates.map(t => (<div key={t.id} style={{...s.card, display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}><div><div style={{ fontWeight: 500 }}>{t.name}</div><div style={{ fontSize: 11, color: colors.textMuted }}>{t.table_config?.length || 0} mese</div></div><div style={{ display: 'flex', gap: 8 }}><button onClick={async () => { await applyLayoutTemplate(t.id, selectedEvent.id); loadEventData(selectedEvent.id) }} style={{...s.btnSm, backgroundColor: colors.champagne, color: colors.noir}}>AplicÄƒ</button><button onClick={() => handleDeleteTemplate(t.id)} style={{...s.btnSm, backgroundColor: 'transparent', color: colors.error, border: `1px solid ${colors.error}`}}>âœ•</button></div></div>))}</div>)}</>)}
        {activeTab === 'reservations' && selectedEvent && (<><div style={s.title}>RezervÄƒri: {selectedEvent.name}</div><div style={{ fontSize: 12, color: colors.textMuted, marginBottom: 16 }}>Click pe o masÄƒ pentru a adÄƒuga/È™terge rezervare</div>{renderGrid(true)}{reservations.length > 0 && (<div style={{ marginTop: 24 }}><div style={s.title}>Lista rezervÄƒri ({reservations.length})</div>{reservations.map(r => { const t = eventTables.find(t => t.id === r.event_table_id); return (<div key={r.id} style={{...s.card, display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}><div><div style={{ fontWeight: 500 }}>{r.customer_name} {r.is_vip && <span style={{...s.badge, backgroundColor: colors.champagne, color: colors.noir}}>VIP</span>}</div><div style={{ fontSize: 12, color: colors.textMuted }}>{t?.table_number} â€¢ {r.party_size} pers â€¢ {r.reservation_time}</div></div><button onClick={() => handleDeleteRes(r.id)} style={{...s.btnSm, backgroundColor: 'transparent', color: colors.error, border: `1px solid ${colors.error}`}}>âœ•</button></div>) })}</div>)}</>)}
        {activeTab === 'menu' && (<><div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16, flexWrap: 'wrap', gap: 10 }}><div style={s.title}>Meniu ({menuItems.length} produse)</div><div style={{ display: 'flex', gap: 8, flexWrap: 'wrap' }}><button onClick={() => setSelectMode(!selectMode)} style={{...s.btnSm, backgroundColor: selectMode ? colors.champagne : 'transparent', color: selectMode ? colors.noir : colors.textMuted, border: `1px solid ${selectMode ? colors.champagne : colors.border}`}}>{selectMode ? 'âœ“ Selectare' : 'â˜ Selectare'}</button><button onClick={openCategoryOrderModal} style={{...s.btnSm, backgroundColor: 'transparent', color: colors.textMuted, border: `1px solid ${colors.border}`}}>ğŸ“‘ Ordine</button><button onClick={handleCreateCategory} style={{...s.btnSm, backgroundColor: 'transparent', color: colors.textMuted, border: `1px solid ${colors.border}`}}>+ Cat</button><button onClick={() => setShowMenuTemplateModal(true)} style={{...s.btnSm, backgroundColor: 'transparent', color: colors.champagne, border: `1px solid ${colors.champagne}`}}>ğŸ’¾</button><button onClick={() => { setEditingProduct(null); setProductForm({ name: '', description: '', default_price: '', category_id: categories[0]?.id || '', product_type: 'cocktail', badge: '', is_available: true }); setShowProductModal(true) }} style={{...s.btn, backgroundColor: colors.champagne, color: colors.noir}}>+ Produs</button></div></div>{selectMode && selectedItems.size > 0 && (<div style={{ display: 'flex', gap: 8, marginBottom: 16, padding: 12, backgroundColor: `${colors.champagne}15`, borderRadius: 8, flexWrap: 'wrap', alignItems: 'center' }}><span style={{ fontSize: 12, color: colors.champagne, fontWeight: 600 }}>{selectedItems.size} selectate</span><div style={{ flex: 1 }} /><button onClick={() => setShowBulkPriceModal(true)} style={{...s.btnSm, backgroundColor: colors.warning, color: colors.noir}}>ğŸ’°</button><button onClick={() => handleBulkToggleStock(true)} style={{...s.btnSm, backgroundColor: colors.success, color: '#fff'}}>âœ“</button><button onClick={() => handleBulkToggleStock(false)} style={{...s.btnSm, backgroundColor: colors.textMuted, color: '#fff'}}>âœ—</button><button onClick={handleBulkDelete} style={{...s.btnSm, backgroundColor: colors.error, color: '#fff'}}>ğŸ—‘ï¸</button><button onClick={() => { setSelectedItems(new Set()); setSelectMode(false) }} style={{...s.btnSm, backgroundColor: 'transparent', color: colors.textMuted, border: `1px solid ${colors.border}`}}>Ã—</button></div>)}{categories.map(cat => { const catItems = menuItems.filter(m => m.category_id === cat.id).sort((a, b) => (a.sort_order || 0) - (b.sort_order || 0)); const allCatSelected = catItems.length > 0 && catItems.every(m => selectedItems.has(m.id)); return (<div key={cat.id} style={{ marginBottom: 24 }}><div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12, padding: '8px 12px', backgroundColor: `${colors.champagne}10`, borderRadius: 6 }}><div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>{selectMode && (<div onClick={() => selectAllInCategory(cat.id)} style={{...s.checkbox, borderColor: allCatSelected ? colors.champagne : colors.border, backgroundColor: allCatSelected ? colors.champagne : 'transparent'}}>{allCatSelected && <span style={{ color: colors.noir, fontSize: 12 }}>âœ“</span>}</div>)}<div style={{ fontSize: 14, fontWeight: 600, color: colors.champagne }}>{cat.name}</div><span style={{ fontSize: 11, color: colors.textMuted }}>({catItems.length})</span></div><div style={{ display: 'flex', gap: 8 }}><button onClick={() => handleEditCategory(cat)} style={{ background: 'none', border: 'none', color: colors.textMuted, fontSize: 12, cursor: 'pointer' }}>âœï¸</button><button onClick={() => handleDeleteCategory(cat.id)} style={{ background: 'none', border: 'none', color: colors.error, fontSize: 12, cursor: 'pointer', opacity: 0.6 }}>âœ•</button></div></div>{catItems.map((item, idx) => (<div key={item.id} style={{...s.card, opacity: item.is_available ? 1 : 0.5, display: 'flex', alignItems: 'center', gap: 12 }}>{selectMode && (<div onClick={() => toggleItemSelection(item.id)} style={{...s.checkbox, borderColor: selectedItems.has(item.id) ? colors.champagne : colors.border, backgroundColor: selectedItems.has(item.id) ? colors.champagne : 'transparent'}}>{selectedItems.has(item.id) && <span style={{ color: colors.noir, fontSize: 12 }}>âœ“</span>}</div>)}{!selectMode && (<div style={{ display: 'flex', flexDirection: 'column', gap: 2 }}><button onClick={() => handleMoveProduct(item, 'up')} disabled={idx === 0} style={{ background: 'none', border: 'none', color: idx === 0 ? colors.border : colors.textMuted, fontSize: 10, cursor: idx === 0 ? 'default' : 'pointer', padding: 2 }}>â–²</button><button onClick={() => handleMoveProduct(item, 'down')} disabled={idx === catItems.length - 1} style={{ background: 'none', border: 'none', color: idx === catItems.length - 1 ? colors.border : colors.textMuted, fontSize: 10, cursor: idx === catItems.length - 1 ? 'default' : 'pointer', padding: 2 }}>â–¼</button></div>)}<div style={{ flex: 1 }}><div style={{ fontWeight: 500, marginBottom: 4 }}>{item.name}{item.badge && <span style={{...s.badge, backgroundColor: item.badge === 'popular' ? colors.error : item.badge === 'premium' ? colors.champagne : item.badge === 'new' ? colors.success : colors.normal, color: item.badge === 'premium' ? colors.noir : '#fff' }}>{item.badge}</span>}{!item.is_available && <span style={{...s.badge, backgroundColor: colors.textMuted }}>STOC 0</span>}</div>{item.description && <div style={{ fontSize: 12, color: colors.textMuted }}>{item.description}</div>}<div style={{ fontSize: 11, color: colors.textMuted, marginTop: 4 }}>{item.product_type || 'other'}</div></div><div style={{ display: 'flex', alignItems: 'center', gap: 8 }}><div style={{ fontSize: 15, color: colors.champagne, fontWeight: 500, marginRight: 8 }}>{item.default_price} LEI</div>{!selectMode && <><button onClick={() => handleToggleStock(item)} style={{...s.btnSm, backgroundColor: 'transparent', color: item.is_available ? colors.success : colors.error, border: `1px solid ${item.is_available ? colors.success : colors.error}`, padding: '4px 8px' }}>{item.is_available ? 'âœ“' : 'âœ—'}</button><button onClick={() => openEditProduct(item)} style={{...s.btnSm, backgroundColor: 'transparent', color: colors.champagne, border: `1px solid ${colors.champagne}`, padding: '4px 8px' }}>âœï¸</button><button onClick={() => handleDeleteProduct(item.id)} style={{...s.btnSm, backgroundColor: 'transparent', color: colors.error, border: `1px solid ${colors.error}`, padding: '4px 8px' }}>âœ•</button></>}</div></div>))}</div>) })}{menuTemplates?.length > 0 && (<div style={{ marginTop: 24 }}><div style={s.title}>Template-uri meniu</div>{menuTemplates.map(t => (<div key={t.id} style={{...s.card, display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}><div><div style={{ fontWeight: 500, display: 'flex', alignItems: 'center', gap: 8 }}>{t.name}{defaultTemplateId === t.id && <span style={{...s.badge, backgroundColor: colors.success, color: '#fff'}}>DEFAULT</span>}</div><div style={{ fontSize: 11, color: colors.textMuted }}>{t.menu_config?.length || 0} produse</div></div><div style={{ display: 'flex', gap: 8 }}><button onClick={() => handleSetDefaultTemplate(t.id)} style={{...s.btnSm, backgroundColor: defaultTemplateId === t.id ? colors.success : 'transparent', color: defaultTemplateId === t.id ? '#fff' : colors.success, border: `1px solid ${colors.success}`}}>{defaultTemplateId === t.id ? 'âœ“' : 'â˜†'}</button><button onClick={() => handleDeleteMenuTemplate(t.id)} style={{...s.btnSm, backgroundColor: 'transparent', color: colors.error, border: `1px solid ${colors.error}`}}>âœ•</button></div></div>))}</div>)}</>)}
        {activeTab === 'qr' && selectedEvent && (<><div style={s.title}>QR Codes: {selectedEvent.name}</div>{eventTables.map(t => (<div key={t.id} style={{...s.card, display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}><div><div style={{ fontWeight: 500 }}>{t.table_number}</div><div style={{ fontSize: 11, color: colors.textMuted }}>/order/{selectedEvent.id}/{t.id}</div></div><button onClick={() => navigator.clipboard.writeText(`${window.location.origin}/order/${selectedEvent.id}/${t.id}`)} style={{...s.btnSm, backgroundColor: colors.champagne, color: colors.noir}}>ğŸ“‹ Copy</button></div>))}</>)}
        {activeTab === 'waiters' && (<><div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 }}><div style={s.title}>Staff</div><button onClick={() => setShowWaiterModal(true)} style={{...s.btn, backgroundColor: colors.champagne, color: colors.noir}}>+ OspÄƒtar</button></div><div style={s.filterRow}>{['active', 'deleted', 'all'].map(f => (<button key={f} onClick={() => setWaiterFilter(f)} style={{...s.filterBtn, backgroundColor: waiterFilter === f ? colors.champagne : 'transparent', color: waiterFilter === f ? colors.noir : colors.textMuted}}>{f === 'active' ? 'Activi' : f === 'deleted' ? 'È˜terÈ™i' : 'ToÈ›i'}</button>))}</div>{waiters.map(w => (<div key={w.id} onClick={() => loadWaiterStats(w)} style={{...s.card, cursor: 'pointer', opacity: w.is_active ? 1 : 0.5}}><div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}><div><div style={{ fontWeight: 500 }}>{w.name}</div><div style={{ fontSize: 12, color: colors.textMuted }}>{w.phone}</div></div><div style={{ display: 'flex', gap: 8, alignItems: 'center' }}>{selectedEvent && (<button onClick={(e) => { e.stopPropagation(); handleToggleWaiterEvent(w.id) }} style={{...s.btnSm, backgroundColor: eventWaiters.some(ew => ew.waiter_id === w.id) ? colors.success : 'transparent', color: eventWaiters.some(ew => ew.waiter_id === w.id) ? '#fff' : colors.textMuted, border: `1px solid ${eventWaiters.some(ew => ew.waiter_id === w.id) ? colors.success : colors.border}`}}>{eventWaiters.some(ew => ew.waiter_id === w.id) ? 'âœ“ Activ' : 'AdaugÄƒ'}</button>)}{w.is_active ? (<button onClick={(e) => handleDeleteWaiter(e, w.id)} style={{...s.btnSm, backgroundColor: 'transparent', color: colors.error, border: `1px solid ${colors.error}`}}>âœ•</button>) : (<button onClick={(e) => { e.stopPropagation(); handleRestoreWaiter(w.id) }} style={{...s.btnSm, backgroundColor: colors.success, color: '#fff'}}>â†©ï¸</button>)}</div></div></div>))}{selectedEvent && eventTables.length > 0 && (<div style={{ marginTop: 32 }}><div style={s.title}>Atribuire mese: {selectedEvent.name}</div>{renderStaffGrid()}</div>)}</>)}
        {activeTab === 'customers' && (<><div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 }}><div style={s.title}>ClienÈ›i ({crmCustomers.length})</div><button onClick={loadCRMCustomers} style={{...s.btnSm, backgroundColor: colors.champagne, color: colors.noir}}>ğŸ”„ Refresh</button></div>{crmCustomers.length === 0 ? (<div style={{ textAlign: 'center', padding: 48, color: colors.textMuted }}><div style={{ fontSize: 48, marginBottom: 16 }}>ğŸ‘¥</div><p>Niciun client Ã®ncÄƒ</p><p style={{ fontSize: 12 }}>ClienÈ›ii apar din rezervÄƒri</p></div>) : crmCustomers.map((c, idx) => (<div key={idx} style={{...s.card, cursor: 'pointer'}} onClick={() => { setSelectedCustomer(c); setShowCustomerModal(true) }}><div style={{ display: 'flex', alignItems: 'center', gap: 16 }}><div style={{ width: 48, height: 48, borderRadius: '50%', backgroundColor: c.isVip ? `${colors.vip}30` : `${colors.normal}20`, border: `2px solid ${c.isVip ? colors.vip : colors.normal}`, display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 20 }}>{c.isVip ? 'â­' : 'ğŸ‘¤'}</div><div style={{ flex: 1 }}><div style={{ fontWeight: 500 }}>{c.name} {c.isVip && <span style={{...s.badge, backgroundColor: colors.vip, color: colors.noir}}>VIP</span>}</div><div style={{ fontSize: 11, color: colors.textMuted }}>{c.phone || ''} â€¢ {c.eventCount || 0} evenimente</div></div><div style={{ textAlign: 'right' }}><div style={{ fontSize: 18, fontWeight: 600, color: colors.champagne }}>{(c.totalSpend || 0).toLocaleString()}</div><div style={{ fontSize: 10, color: colors.textMuted }}>LEI</div></div></div></div>))}</>)}
      </div>

      {showEventModal && <div style={s.modal} onClick={closeEventModal}><div style={s.modalBox} onClick={e => e.stopPropagation()}><div style={s.modalHead}><span style={{ fontSize: 16, fontWeight: 600 }}>{editingEvent ? 'EditeazÄƒ' : 'Eveniment nou'}</span><button onClick={closeEventModal} style={{ background: 'none', border: 'none', color: colors.textMuted, fontSize: 20, cursor: 'pointer' }}>âœ•</button></div><div style={s.modalBody}><label style={s.label}>Nume</label><input value={eventForm.name} onChange={e => setEventForm({...eventForm, name: e.target.value})} style={s.input} /><label style={s.label}>Data</label><input type="date" value={eventForm.event_date} onChange={e => setEventForm({...eventForm, event_date: e.target.value})} style={s.input} /><label style={s.label}>Ora</label><input type="time" value={eventForm.start_time} onChange={e => setEventForm({...eventForm, start_time: e.target.value})} style={s.input} />{!editingEvent && layoutTemplates.length > 0 && <><label style={s.label}>Layout</label><select value={selectedTemplate || ''} onChange={e => setSelectedTemplate(e.target.value || null)} style={s.select}><option value="">FÄƒrÄƒ</option>{layoutTemplates.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}</select></>}{!editingEvent && menuTemplates.length > 0 && <><label style={s.label}>Meniu</label><select value={selectedMenuTemplate || ''} onChange={e => setSelectedMenuTemplate(e.target.value || null)} style={s.select}><option value="">{defaultTemplateId ? 'Default' : 'FÄƒrÄƒ'}</option>{menuTemplates.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}</select></>}</div><div style={s.modalFoot}><button onClick={closeEventModal} style={{...s.btn, backgroundColor: 'transparent', color: colors.textMuted, border: `1px solid ${colors.border}`}}>AnuleazÄƒ</button><button onClick={editingEvent ? handleUpdateEvent : handleCreateEvent} style={{...s.btn, backgroundColor: colors.champagne, color: colors.noir}}>{editingEvent ? 'SalveazÄƒ' : 'CreeazÄƒ'}</button></div></div></div>}
      {showWaiterModal && <div style={s.modal} onClick={() => setShowWaiterModal(false)}><div style={s.modalBox} onClick={e => e.stopPropagation()}><div style={s.modalHead}><span style={{ fontSize: 16, fontWeight: 600 }}>OspÄƒtar nou</span><button onClick={() => setShowWaiterModal(false)} style={{ background: 'none', border: 'none', color: colors.textMuted, fontSize: 20, cursor: 'pointer' }}>âœ•</button></div><div style={s.modalBody}><label style={s.label}>Nume</label><input value={waiterForm.name} onChange={e => setWaiterForm({...waiterForm, name: e.target.value})} style={s.input} /><label style={s.label}>Telefon</label><input value={waiterForm.phone} onChange={e => setWaiterForm({...waiterForm, phone: e.target.value})} style={s.input} /></div><div style={s.modalFoot}><button onClick={() => setShowWaiterModal(false)} style={{...s.btn, backgroundColor: 'transparent', color: colors.textMuted, border: `1px solid ${colors.border}`}}>AnuleazÄƒ</button><button onClick={handleCreateWaiter} style={{...s.btn, backgroundColor: colors.champagne, color: colors.noir}}>AdaugÄƒ</button></div></div></div>}
      {showReservationModal && selectedTableForRes && <div style={s.modal} onClick={() => { setShowReservationModal(false); setEditingReservation(null) }}><div style={s.modalBox} onClick={e => e.stopPropagation()}><div style={s.modalHead}><span style={{ fontSize: 16, fontWeight: 600 }}>{editingReservation ? 'EditeazÄƒ' : 'Rezervare'}: {selectedTableForRes.table_number}</span><button onClick={() => { setShowReservationModal(false); setEditingReservation(null) }} style={{ background: 'none', border: 'none', color: colors.textMuted, fontSize: 20, cursor: 'pointer' }}>âœ•</button></div><div style={s.modalBody}><label style={s.label}>Nume</label><input value={reservationForm.customer_name} onChange={e => setReservationForm({...reservationForm, customer_name: e.target.value})} style={s.input} /><label style={s.label}>Telefon</label><input value={reservationForm.customer_phone} onChange={e => setReservationForm({...reservationForm, customer_phone: e.target.value})} style={s.input} /><label style={s.label}>Persoane</label><input type="number" value={reservationForm.party_size} onChange={e => setReservationForm({...reservationForm, party_size: parseInt(e.target.value)})} style={s.input} /><label style={s.label}>Ora</label><input type="time" value={reservationForm.reservation_time} onChange={e => setReservationForm({...reservationForm, reservation_time: e.target.value})} style={s.input} /><label style={s.label}>Note</label><input value={reservationForm.notes} onChange={e => setReservationForm({...reservationForm, notes: e.target.value})} style={s.input} /><label style={{ display: 'flex', alignItems: 'center', gap: 8 }}><input type="checkbox" checked={reservationForm.is_vip} onChange={e => setReservationForm({...reservationForm, is_vip: e.target.checked})} /><span style={{ fontSize: 13, color: colors.textMuted }}>VIP</span></label></div><div style={s.modalFoot}>{editingReservation && <button onClick={() => { handleDeleteRes(editingReservation.id); setShowReservationModal(false); setEditingReservation(null) }} style={{...s.btn, backgroundColor: colors.error, color: '#fff'}}>ğŸ—‘ï¸ È˜terge</button>}<div style={{flex:1}}/><button onClick={() => { setShowReservationModal(false); setEditingReservation(null) }} style={{...s.btn, backgroundColor: 'transparent', color: colors.textMuted, border: `1px solid ${colors.border}`}}>AnuleazÄƒ</button><button onClick={editingReservation ? handleUpdateRes : handleCreateRes} style={{...s.btn, backgroundColor: colors.champagne, color: colors.noir}}>{editingReservation ? 'SalveazÄƒ' : 'RezervÄƒ'}</button></div></div></div>}
      {showProductModal && <div style={s.modal} onClick={closeProductModal}><div style={s.modalBox} onClick={e => e.stopPropagation()}><div style={s.modalHead}><span style={{ fontSize: 16, fontWeight: 600 }}>{editingProduct ? 'EditeazÄƒ' : 'Produs nou'}</span><button onClick={closeProductModal} style={{ background: 'none', border: 'none', color: colors.textMuted, fontSize: 20, cursor: 'pointer' }}>âœ•</button></div><div style={s.modalBody}><label style={s.label}>Nume</label><input value={productForm.name} onChange={e => setProductForm({...productForm, name: e.target.value})} style={s.input} /><label style={s.label}>Descriere</label><input value={productForm.description} onChange={e => setProductForm({...productForm, description: e.target.value})} style={s.input} /><label style={s.label}>PreÈ›</label><input type="number" value={productForm.default_price} onChange={e => setProductForm({...productForm, default_price: e.target.value})} style={s.input} /><label style={s.label}>Categorie</label><select value={productForm.category_id} onChange={e => setProductForm({...productForm, category_id: e.target.value})} style={s.select}><option value="">-</option>{categories.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</select><label style={s.label}>Tip</label><select value={productForm.product_type} onChange={e => setProductForm({...productForm, product_type: e.target.value})} style={s.select}>{PRODUCT_TYPES.map(t => <option key={t} value={t}>{t}</option>)}</select><label style={s.label}>Badge</label><select value={productForm.badge} onChange={e => setProductForm({...productForm, badge: e.target.value})} style={s.select}><option value="">-</option>{BADGES.map(b => <option key={b} value={b}>{b}</option>)}</select></div><div style={s.modalFoot}><button onClick={closeProductModal} style={{...s.btn, backgroundColor: 'transparent', color: colors.textMuted, border: `1px solid ${colors.border}`}}>AnuleazÄƒ</button><button onClick={editingProduct ? handleUpdateProduct : handleCreateProduct} style={{...s.btn, backgroundColor: colors.champagne, color: colors.noir}}>{editingProduct ? 'SalveazÄƒ' : 'AdaugÄƒ'}</button></div></div></div>}
      {showLayoutModal && <div style={s.modal} onClick={() => setShowLayoutModal(false)}><div style={s.modalBox} onClick={e => e.stopPropagation()}><div style={s.modalHead}><span style={{ fontSize: 16, fontWeight: 600 }}>SalveazÄƒ Layout</span><button onClick={() => setShowLayoutModal(false)} style={{ background: 'none', border: 'none', color: colors.textMuted, fontSize: 20, cursor: 'pointer' }}>âœ•</button></div><div style={s.modalBody}><label style={s.label}>Nume</label><input value={layoutName} onChange={e => setLayoutName(e.target.value)} style={s.input} /></div><div style={s.modalFoot}><button onClick={() => setShowLayoutModal(false)} style={{...s.btn, backgroundColor: 'transparent', color: colors.textMuted, border: `1px solid ${colors.border}`}}>AnuleazÄƒ</button><button onClick={handleSaveLayout} style={{...s.btn, backgroundColor: colors.champagne, color: colors.noir}}>SalveazÄƒ</button></div></div></div>}
      {showMenuTemplateModal && <div style={s.modal} onClick={() => setShowMenuTemplateModal(false)}><div style={s.modalBox} onClick={e => e.stopPropagation()}><div style={s.modalHead}><span style={{ fontSize: 16, fontWeight: 600 }}>SalveazÄƒ Meniu</span><button onClick={() => setShowMenuTemplateModal(false)} style={{ background: 'none', border: 'none', color: colors.textMuted, fontSize: 20, cursor: 'pointer' }}>âœ•</button></div><div style={s.modalBody}><div style={{ textAlign: 'center', padding: 16, marginBottom: 16, backgroundColor: `${colors.champagne}15`, borderRadius: 8 }}><div style={{ fontSize: 32, fontWeight: 700, color: colors.champagne }}>{menuItems.length}</div><div style={{ fontSize: 12, color: colors.textMuted }}>produse</div></div><label style={s.label}>Nume</label><input value={menuTemplateName} onChange={e => setMenuTemplateName(e.target.value)} style={s.input} /></div><div style={s.modalFoot}><button onClick={() => setShowMenuTemplateModal(false)} style={{...s.btn, backgroundColor: 'transparent', color: colors.textMuted, border: `1px solid ${colors.border}`}}>AnuleazÄƒ</button><button onClick={handleSaveMenuTemplate} style={{...s.btn, backgroundColor: colors.champagne, color: colors.noir}}>SalveazÄƒ</button></div></div></div>}
      {showBulkPriceModal && <div style={s.modal} onClick={() => setShowBulkPriceModal(false)}><div style={s.modalBox} onClick={e => e.stopPropagation()}><div style={s.modalHead}><span style={{ fontSize: 16, fontWeight: 600 }}>ModificÄƒ preÈ›uri</span><button onClick={() => setShowBulkPriceModal(false)} style={{ background: 'none', border: 'none', color: colors.textMuted, fontSize: 20, cursor: 'pointer' }}>âœ•</button></div><div style={s.modalBody}><div style={{ textAlign: 'center', padding: 12, marginBottom: 16, backgroundColor: `${colors.warning}15`, borderRadius: 8 }}><div style={{ fontSize: 14, color: colors.warning }}>{selectMode && selectedItems.size > 0 ? `${selectedItems.size} produse` : `${menuItems.length} produse`}</div></div><div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12, marginBottom: 16 }}><button onClick={() => setBulkPriceChange({...bulkPriceChange, type: 'percent'})} style={{...s.btn, backgroundColor: bulkPriceChange.type === 'percent' ? colors.champagne : 'transparent', color: bulkPriceChange.type === 'percent' ? colors.noir : colors.textMuted, border: `1px solid ${colors.border}`}}>%</button><button onClick={() => setBulkPriceChange({...bulkPriceChange, type: 'fixed'})} style={{...s.btn, backgroundColor: bulkPriceChange.type === 'fixed' ? colors.champagne : 'transparent', color: bulkPriceChange.type === 'fixed' ? colors.noir : colors.textMuted, border: `1px solid ${colors.border}`}}>LEI</button></div><label style={s.label}>{bulkPriceChange.type === 'percent' ? 'Procent' : 'SumÄƒ'}</label><input type="number" value={bulkPriceChange.value} onChange={e => setBulkPriceChange({...bulkPriceChange, value: parseFloat(e.target.value) || 0})} style={s.input} /></div><div style={s.modalFoot}><button onClick={() => setShowBulkPriceModal(false)} style={{...s.btn, backgroundColor: 'transparent', color: colors.textMuted, border: `1px solid ${colors.border}`}}>AnuleazÄƒ</button><button onClick={handleBulkPrice} style={{...s.btn, backgroundColor: colors.warning, color: colors.noir}}>AplicÄƒ</button></div></div></div>}
      {showCategoryOrderModal && <div style={s.modal} onClick={() => setShowCategoryOrderModal(false)}><div style={s.modalBox} onClick={e => e.stopPropagation()}><div style={s.modalHead}><span style={{ fontSize: 16, fontWeight: 600 }}>Ordine categorii</span><button onClick={() => setShowCategoryOrderModal(false)} style={{ background: 'none', border: 'none', color: colors.textMuted, fontSize: 20, cursor: 'pointer' }}>âœ•</button></div><div style={s.modalBody}>{tempCategoryOrder.map((cat, idx) => (<div key={cat.id} style={{ display: 'flex', alignItems: 'center', gap: 12, padding: 12, marginBottom: 8, backgroundColor: colors.noir, borderRadius: 6, border: `1px solid ${colors.border}` }}><div style={{ display: 'flex', flexDirection: 'column', gap: 2 }}><button onClick={() => moveCategoryInOrder(idx, 'up')} disabled={idx === 0} style={{ background: 'none', border: 'none', color: idx === 0 ? colors.border : colors.champagne, fontSize: 14, cursor: idx === 0 ? 'default' : 'pointer', padding: 2 }}>â–²</button><button onClick={() => moveCategoryInOrder(idx, 'down')} disabled={idx === tempCategoryOrder.length - 1} style={{ background: 'none', border: 'none', color: idx === tempCategoryOrder.length - 1 ? colors.border : colors.champagne, fontSize: 14, cursor: idx === tempCategoryOrder.length - 1 ? 'default' : 'pointer', padding: 2 }}>â–¼</button></div><span style={{ flex: 1, fontWeight: 500 }}>{cat.name}</span><span style={{ fontSize: 11, color: colors.textMuted }}>{menuItems.filter(m => m.category_id === cat.id).length}</span></div>))}</div><div style={s.modalFoot}><button onClick={() => setShowCategoryOrderModal(false)} style={{...s.btn, backgroundColor: 'transparent', color: colors.textMuted, border: `1px solid ${colors.border}`}}>AnuleazÄƒ</button><button onClick={saveCategoryOrder} style={{...s.btn, backgroundColor: colors.champagne, color: colors.noir}}>SalveazÄƒ</button></div></div></div>}
      {showCategoryEditModal && editingCategory && <div style={s.modal} onClick={() => setShowCategoryEditModal(false)}><div style={s.modalBox} onClick={e => e.stopPropagation()}><div style={s.modalHead}><span style={{ fontSize: 16, fontWeight: 600 }}>EditeazÄƒ categorie</span><button onClick={() => setShowCategoryEditModal(false)} style={{ background: 'none', border: 'none', color: colors.textMuted, fontSize: 20, cursor: 'pointer' }}>âœ•</button></div><div style={s.modalBody}><label style={s.label}>Nume</label><input value={categoryName} onChange={e => setCategoryName(e.target.value)} style={s.input} /></div><div style={s.modalFoot}><button onClick={() => setShowCategoryEditModal(false)} style={{...s.btn, backgroundColor: 'transparent', color: colors.textMuted, border: `1px solid ${colors.border}`}}>AnuleazÄƒ</button><button onClick={handleUpdateCategory} style={{...s.btn, backgroundColor: colors.champagne, color: colors.noir}}>SalveazÄƒ</button></div></div></div>}
      {showWaiterStatsModal && selectedWaiter && <div style={s.modal} onClick={() => setShowWaiterStatsModal(false)}><div style={s.modalBox} onClick={e => e.stopPropagation()}><div style={s.modalHead}><span style={{ fontSize: 16, fontWeight: 600 }}>ğŸ“Š {selectedWaiter.name}</span><button onClick={() => setShowWaiterStatsModal(false)} style={{ background: 'none', border: 'none', color: colors.textMuted, fontSize: 20, cursor: 'pointer' }}>âœ•</button></div><div style={s.modalBody}><div style={{ marginBottom: 24 }}><div style={{ fontSize: 11, color: colors.textMuted, letterSpacing: 2, marginBottom: 12 }}>TOTAL</div><div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12 }}><div style={s.stat}><div style={s.statVal}>{waiterStats.global?.totalSales?.toLocaleString() || 0}</div><div style={s.statLbl}>LEI</div></div><div style={s.stat}><div style={s.statVal}>{waiterStats.global?.totalOrders || 0}</div><div style={s.statLbl}>COMENZI</div></div></div></div>{selectedEvent && (<div><div style={{ fontSize: 11, color: colors.textMuted, letterSpacing: 2, marginBottom: 12 }}>{selectedEvent.name}</div><div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12 }}><div style={s.stat}><div style={s.statVal}>{waiterStats.event?.totalSales?.toLocaleString() || 0}</div><div style={s.statLbl}>LEI</div></div><div style={s.stat}><div style={s.statVal}>{waiterStats.event?.totalOrders || 0}</div><div style={s.statLbl}>COMENZI</div></div></div></div>)}</div></div></div>}
      {showAssignModal && selectedTableForAssign && <div style={s.modal} onClick={() => setShowAssignModal(false)}><div style={s.modalBox} onClick={e => e.stopPropagation()}><div style={s.modalHead}><span style={{ fontSize: 16, fontWeight: 600 }}>Atribuie: {selectedTableForAssign.table_number}</span><button onClick={() => setShowAssignModal(false)} style={{ background: 'none', border: 'none', color: colors.textMuted, fontSize: 20, cursor: 'pointer' }}>âœ•</button></div><div style={s.modalBody}>{activeWaitersOnEvent.length === 0 ? <div style={{ textAlign: 'center', padding: 24, color: colors.textMuted }}>Nu ai ospÄƒtari activi pe acest eveniment</div> : activeWaitersOnEvent.map(w => { const isAssigned = tableAssignments.find(a => a.event_table_id === selectedTableForAssign.id)?.waiters?.id === w.id; return (<div key={w.id} onClick={() => handleAssignWaiterToTable(w.id)} style={{ display: 'flex', alignItems: 'center', gap: 12, padding: 14, marginBottom: 8, backgroundColor: isAssigned ? `${waiterColorMap[w.id]}30` : colors.noir, border: `2px solid ${isAssigned ? waiterColorMap[w.id] : colors.border}`, borderRadius: 8, cursor: 'pointer' }}><div style={{ width: 16, height: 16, borderRadius: '50%', backgroundColor: waiterColorMap[w.id] }} /><span style={{ flex: 1, fontWeight: 500 }}>{w.name}</span>{isAssigned && <span style={{ color: waiterColorMap[w.id], fontWeight: 600 }}>âœ“</span>}</div>) })}{tableAssignments.find(a => a.event_table_id === selectedTableForAssign.id) && <button onClick={handleUnassignTable} style={{...s.btn, width: '100%', marginTop: 8, backgroundColor: 'transparent', color: colors.error, border: `1px solid ${colors.error}`}}>EliminÄƒ atribuirea</button>}</div></div></div>}
      {showCustomerModal && selectedCustomer && <div style={s.modal} onClick={() => setShowCustomerModal(false)}><div style={{...s.modalBox, maxWidth: 500}} onClick={e => e.stopPropagation()}><div style={s.modalHead}><div style={{ display: 'flex', alignItems: 'center', gap: 12 }}><div style={{ width: 40, height: 40, borderRadius: '50%', backgroundColor: selectedCustomer.isVip ? `${colors.vip}30` : `${colors.normal}20`, border: `2px solid ${selectedCustomer.isVip ? colors.vip : colors.normal}`, display: 'flex', alignItems: 'center', justifyContent: 'center' }}>{selectedCustomer.isVip ? 'â­' : 'ğŸ‘¤'}</div><div><div style={{ fontWeight: 600 }}>{selectedCustomer.name}</div>{selectedCustomer.isVip && <span style={{...s.badge, backgroundColor: colors.vip, color: colors.noir}}>VIP</span>}</div></div><button onClick={() => setShowCustomerModal(false)} style={{ background: 'none', border: 'none', color: colors.textMuted, fontSize: 20, cursor: 'pointer' }}>âœ•</button></div><div style={s.modalBody}><div style={{ backgroundColor: colors.noir, padding: 16, borderRadius: 8, marginBottom: 16 }}>{selectedCustomer.phone && <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0', borderBottom: `1px solid ${colors.border}` }}><span style={{ color: colors.textMuted }}>ğŸ“± Telefon</span><a href={`tel:${selectedCustomer.phone}`} style={{ color: colors.champagne, textDecoration: 'none' }}>{selectedCustomer.phone}</a></div>}{selectedCustomer.email && <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0', borderBottom: `1px solid ${colors.border}` }}><span style={{ color: colors.textMuted }}>âœ‰ï¸ Email</span><span>{selectedCustomer.email}</span></div>}<div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0' }}><span style={{ color: colors.textMuted }}>ğŸ‰ Evenimente</span><span>{selectedCustomer.eventCount || 0}</span></div></div><div style={{ textAlign: 'center', padding: 20, backgroundColor: `${colors.champagne}15`, borderRadius: 8, marginBottom: 16 }}><div style={{ fontSize: 11, color: colors.textMuted, letterSpacing: 2, marginBottom: 4 }}>TOTAL SPEND</div><div style={{ fontSize: 32, fontWeight: 300, color: colors.champagne }}>{(selectedCustomer.totalSpend || 0).toLocaleString()} LEI</div></div><div style={{ fontSize: 11, color: colors.textMuted, letterSpacing: 2, marginBottom: 12 }}>ISTORIC REZERVÄ‚RI</div>{selectedCustomer.reservations?.map((res, idx) => (<div key={idx} style={{ padding: 12, backgroundColor: colors.noir, borderRadius: 6, marginBottom: 8, border: `1px solid ${colors.border}` }}><div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 4 }}><span style={{ fontWeight: 500 }}>{res.events?.name || 'Event'}</span><span style={{ color: colors.champagne, fontWeight: 600 }}>{(res.tableSpend || 0).toLocaleString()} LEI</span></div><div style={{ fontSize: 11, color: colors.textMuted }}>ğŸ“… {res.events?.event_date ? new Date(res.events.event_date).toLocaleDateString('ro-RO') : '-'} â€¢ ğŸª‘ {res.event_tables?.table_number || '-'} â€¢ ğŸ‘¥ {res.party_size}p</div></div>))}</div></div></div>}
    </div>
  )
}
